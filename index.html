<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Test Master</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --text-white: #ffffff;
            --text-gray: #8b8b9e;
            --accent-purple: #8b5cf6;
            --gradient-main: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-green: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-red: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-dark);
            color: var(--text-white);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-gradient {
            position: absolute;
            width: 150%;
            height: 150%;
            top: -25%;
            left: -25%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 40%);
            animation: bgFloat 15s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, -20px); }
        }

        .floating-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            animation: orbFloat 8s ease-in-out infinite;
        }

        .orb-1 { width: 300px; height: 300px; background: rgba(139, 92, 246, 0.3); top: -100px; right: -100px; }
        .orb-2 { width: 200px; height: 200px; background: rgba(236, 72, 153, 0.25); bottom: 20%; left: -50px; animation-delay: -3s; }

        @keyframes orbFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.1); }
        }

        .container {
            max-width: 440px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 100px;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .progress-circle {
            width: 52px;
            height: 52px;
            position: relative;
        }

        .progress-circle svg { transform: rotate(-90deg); }
        .progress-circle circle { fill: none; stroke-width: 4; stroke-linecap: round; }
        .progress-bg { stroke: rgba(255, 255, 255, 0.1); }
        .progress-fill { stroke: url(#progressGradient); transition: stroke-dashoffset 0.6s ease; }

        .progress-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 13px;
            font-weight: 700;
        }

        .score-group { display: flex; gap: 16px; }

        .score-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
        }

        .score-badge.correct { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .score-badge.wrong { background: rgba(239, 68, 68, 0.15); color: #f87171; }

        .question-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 28px;
            padding: 28px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            animation: cardAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient-main);
        }

        @keyframes cardAppear {
            from { opacity: 0; transform: translateY(40px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .question-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--gradient-blue);
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.6;
            margin-bottom: 28px;
        }

        .answers-list { display: flex; flex-direction: column; gap: 12px; }

        .answer-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-option:active:not(.locked) { transform: scale(0.98); }
        .answer-option:not(.locked):hover { border-color: rgba(139, 92, 246, 0.5); background: rgba(139, 92, 246, 0.08); }

        .answer-option.selected {
            border-color: var(--accent-purple);
            background: rgba(139, 92, 246, 0.12);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }

        .answer-option.selected .answer-letter { background: var(--gradient-blue); color: white; border-color: transparent; }

        .answer-option.correct {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.12);
            animation: correctPop 0.4s ease;
        }

        .answer-option.correct .answer-letter { background: var(--gradient-green); color: white; border-color: transparent; }

        @keyframes correctPop { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .answer-option.wrong {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.12);
            animation: wrongShake 0.4s ease;
        }

        .answer-option.wrong .answer-letter { background: var(--gradient-red); color: white; border-color: transparent; }

        @keyframes wrongShake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }

        .answer-option.locked { cursor: default; opacity: 0.6; }
        .answer-option.correct.locked, .answer-option.wrong.locked { opacity: 1; }

        .answer-letter {
            width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            font-weight: 700; font-size: 17px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .answer-content { flex: 1; font-size: 15px; font-weight: 500; line-height: 1.5; }

        .answer-status { font-size: 20px; opacity: 0; transform: scale(0); transition: all 0.3s ease; }
        .answer-option.correct .answer-status, .answer-option.wrong .answer-status { opacity: 1; transform: scale(1); }

        .nav-fixed {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(10, 10, 15, 0.98) 60%, transparent);
            z-index: 100;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            max-width: 440px;
            margin: 0 auto;
        }

        .nav-btn {
            height: 56px;
            border: none;
            border-radius: 16px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-white);
            border: 1px solid rgba(255, 255, 255, 0.08);
            flex: 1;
        }

        .nav-btn:active { transform: scale(0.95); }
        .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .nav-btn.primary {
            flex: 2.5;
            background: var(--gradient-blue);
            border: none;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
        }

        .start-screen {
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .logo-container { margin-bottom: 32px; position: relative; }

        .logo {
            width: 100px; height: 100px;
            background: var(--gradient-main);
            border-radius: 30px;
            display: flex; align-items: center; justify-content: center;
            font-size: 48px;
            box-shadow: 0 0 60px rgba(139, 92, 246, 0.3);
            animation: logoFloat 4s ease-in-out infinite;
        }

        @keyframes logoFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }

        .logo-ring {
            position: absolute;
            top: -15px; left: -15px; right: -15px; bottom: -15px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 38px;
            animation: ringPulse 2s ease-in-out infinite;
        }

        @keyframes ringPulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.2; } }

        .app-title {
            font-size: 32px; font-weight: 800; margin-bottom: 8px;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .app-subtitle { font-size: 15px; color: var(--text-gray); margin-bottom: 48px; }

        .mode-list { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 14px; }

        .mode-card {
            display: flex; align-items: center; gap: 18px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mode-card:hover { border-color: rgba(139, 92, 246, 0.4); background: rgba(139, 92, 246, 0.08); transform: translateY(-4px); }
        .mode-card:active { transform: scale(0.98); }
        .mode-card.featured { background: var(--gradient-blue); border: none; }
        .mode-card.featured:hover { box-shadow: 0 20px 50px rgba(59, 130, 246, 0.4); }

        .mode-icon {
            width: 52px; height: 52px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px;
        }

        .mode-info { flex: 1; }
        .mode-name { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .mode-desc { font-size: 13px; color: var(--text-gray); }
        .mode-card.featured .mode-desc { color: rgba(255, 255, 255, 0.75); }
        .mode-arrow { font-size: 20px; opacity: 0.5; }

        .practice-panel { width: 100%; max-width: 340px; margin-top: 20px; }
        .practice-title { font-size: 14px; color: var(--text-gray); margin-bottom: 16px; }
        .practice-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }

        .practice-chip {
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            font-size: 18px; font-weight: 700;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .practice-chip:hover { border-color: var(--accent-purple); background: rgba(139, 92, 246, 0.1); }
        .practice-chip:active { transform: scale(0.95); }

        .back-btn {
            width: 100%; padding: 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: var(--text-gray);
            font-size: 15px; font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }

        .results-screen {
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .result-emoji { font-size: 72px; margin-bottom: 24px; animation: emojiPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes emojiPop { 0% { transform: scale(0) rotate(-20deg); } 100% { transform: scale(1) rotate(0deg); } }

        .result-circle { width: 160px; height: 160px; position: relative; margin: 0 auto 32px; }
        .result-circle svg { transform: rotate(-90deg); }
        .result-circle circle { fill: none; stroke-width: 10; stroke-linecap: round; }
        .result-bg { stroke: rgba(255, 255, 255, 0.08); }
        .result-fill { stroke: url(#resultGradient); transition: stroke-dashoffset 1.2s ease; }

        .result-percent {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px; font-weight: 800;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .result-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .result-subtitle { font-size: 16px; color: var(--text-gray); margin-bottom: 40px; }

        .stats-row { display: flex; gap: 24px; margin-bottom: 48px; }

        .stat-box {
            padding: 24px 36px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
        }

        .stat-value { font-size: 36px; font-weight: 800; margin-bottom: 4px; }
        .stat-box.correct .stat-value { color: #34d399; }
        .stat-box.wrong .stat-value { color: #f87171; }
        .stat-label { font-size: 13px; color: var(--text-gray); }

        .result-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 280px; }

        .result-btn {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            font-size: 16px; font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .result-btn:active { transform: scale(0.97); }
        .result-btn.primary { background: var(--gradient-blue); color: white; }
        .result-btn.secondary { background: rgba(255, 255, 255, 0.05); color: var(--text-white); border: 1px solid rgba(255, 255, 255, 0.1); }

        .loading-screen { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .loader-wrapper { position: relative; width: 80px; height: 80px; }

        .loader-ring {
            position: absolute;
            width: 100%; height: 100%;
            border: 3px solid transparent;
            border-top-color: var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-ring:nth-child(2) { width: 60px; height: 60px; top: 10px; left: 10px; border-top-color: #ec4899; animation-duration: 0.8s; animation-direction: reverse; }
        .loader-ring:nth-child(3) { width: 40px; height: 40px; top: 20px; left: 20px; border-top-color: #06b6d4; animation-duration: 0.6s; }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { margin-top: 28px; font-size: 15px; color: var(--text-gray); }

        .hidden { display: none !important; }
        .svg-defs { position: absolute; width: 0; height: 0; }
    </style>
</head>
<body>
    <div class="background">
        <div class="bg-gradient"></div>
        <div class="floating-orb orb-1"></div>
        <div class="floating-orb orb-2"></div>
    </div>

    <svg class="svg-defs">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#3b82f6"/>
                <stop offset="100%" style="stop-color:#8b5cf6"/>
            </linearGradient>
            <linearGradient id="resultGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea"/>
                <stop offset="100%" style="stop-color:#f093fb"/>
            </linearGradient>
        </defs>
    </svg>

    <div id="loadingScreen" class="loading-screen">
        <div class="loader-wrapper">
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
        </div>
        <p class="loading-text">Yuklanmoqda...</p>
    </div>

    <div id="startScreen" class="start-screen hidden">
        <div class="logo-container">
            <div class="logo">üìù</div>
            <div class="logo-ring"></div>
        </div>
        <h1 class="app-title">Test Master</h1>
        <p class="app-subtitle">Bilimingizni sinab ko'ring!</p>

        <div class="mode-list" id="modeList">
            <div class="mode-card featured" onclick="startQuiz('test')">
                <div class="mode-icon">üöÄ</div>
                <div class="mode-info">
                    <div class="mode-name">Testni boshlash</div>
                    <div class="mode-desc">Barcha savollar</div>
                </div>
                <span class="mode-arrow">‚Üí</span>
            </div>
            <div class="mode-card" onclick="showPractice()">
                <div class="mode-icon">üéØ</div>
                <div class="mode-info">
                    <div class="mode-name">Mashq rejimi</div>
                    <div class="mode-desc">Tanlangan sonida</div>
                </div>
                <span class="mode-arrow">‚Üí</span>
            </div>
            <div class="mode-card" onclick="startQuiz('learn')">
                <div class="mode-icon">üìñ</div>
                <div class="mode-info">
                    <div class="mode-name">O'rganish</div>
                    <div class="mode-desc">Javoblarni ko'rish</div>
                </div>
                <span class="mode-arrow">‚Üí</span>
            </div>
        </div>

        <div class="practice-panel hidden" id="practicePanel">
            <p class="practice-title">Savollar sonini tanlang:</p>
            <div class="practice-grid" id="practiceGrid"></div>
            <button class="back-btn" onclick="hidePractice()">‚Üê Orqaga</button>
        </div>
    </div>

    <div id="quizScreen" class="container hidden">
        <div class="header">
            <div class="progress-circle">
                <svg viewBox="0 0 52 52" width="52" height="52">
                    <circle class="progress-bg" cx="26" cy="26" r="22"/>
                    <circle class="progress-fill" id="progressCircle" cx="26" cy="26" r="22" stroke-dasharray="138.2" stroke-dashoffset="138.2"/>
                </svg>
                <span class="progress-number" id="progressNum">1/10</span>
            </div>
            <div class="score-group">
                <div class="score-badge correct">‚úì <span id="scoreCorrect">0</span></div>
                <div class="score-badge wrong">‚úó <span id="scoreWrong">0</span></div>
            </div>
        </div>

        <div class="question-card" id="questionCard">
            <div class="question-badge">üìå <span id="qBadge">Savol 1</span></div>
            <p class="question-text" id="qText">Savol matni</p>
            <div class="answers-list" id="answersList"></div>
        </div>
    </div>

    <div id="resultsScreen" class="results-screen hidden">
        <div class="result-emoji" id="resultEmoji">üéâ</div>
        <div class="result-circle">
            <svg viewBox="0 0 160 160" width="160" height="160">
                <circle class="result-bg" cx="80" cy="80" r="70"/>
                <circle class="result-fill" id="resultCircle" cx="80" cy="80" r="70" stroke-dasharray="439.8" stroke-dashoffset="439.8"/>
            </svg>
            <span class="result-percent" id="resultPct">0%</span>
        </div>
        <h2 class="result-title" id="resultTitle">Tabriklaymiz!</h2>
        <p class="result-subtitle" id="resultSub">Ajoyib natija!</p>
        <div class="stats-row">
            <div class="stat-box correct"><div class="stat-value" id="statCorrect">0</div><div class="stat-label">To'g'ri</div></div>
            <div class="stat-box wrong"><div class="stat-value" id="statWrong">0</div><div class="stat-label">Noto'g'ri</div></div>
        </div>
        <div class="result-actions">
            <button class="result-btn primary" onclick="restart()">üîÑ Qayta boshlash</button>
            <button class="result-btn secondary" onclick="closeApp()">üè† Chiqish</button>
        </div>
    </div>

    <div class="nav-fixed hidden" id="navBar">
        <div class="nav-buttons">
            <button class="nav-btn" id="btnPrev" onclick="goPrev()">‚¨ÖÔ∏è</button>
            <button class="nav-btn primary" id="btnMain" onclick="mainAction()">Keyingi ‚Üí</button>
            <button class="nav-btn" onclick="goRandom()">üé≤</button>
            <button class="nav-btn" onclick="closeApp()">‚úï</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let questions = [], current = 0, selected = null, answered = false;
        let score = { correct: 0, wrong: 0 }, mode = 'test', maps = {};

        function init() {
            questions = getDemo();
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('startScreen').classList.remove('hidden');
            }, 600);
        }

        function getDemo() {
            return [
                { question: "Python'da ro'yxat yaratish uchun qaysi qavslar ishlatiladi?", answers: ["[]", "{}", "()", "<>"], correct_index: 0 },
                { question: "HTML da sarlavha uchun qaysi teg ishlatiladi?", answers: ["<head>", "<h1>", "<title>", "<header>"], correct_index: 1 },
                { question: "JavaScript'da o'zgaruvchi e'lon qilish uchun qaysi kalit so'z ishlatiladi?", answers: ["var", "int", "string", "define"], correct_index: 0 },
                { question: "CSS da rangni qizil qilish uchun qaysi qiymat ishlatiladi?", answers: ["blue", "green", "red", "yellow"], correct_index: 2 },
                { question: "SQL da ma'lumotlarni tanlash uchun qaysi buyruq ishlatiladi?", answers: ["GET", "SELECT", "FETCH", "RETRIEVE"], correct_index: 1 },
                { question: "Git da o'zgarishlarni saqlash uchun qaysi buyruq ishlatiladi?", answers: ["git save", "git commit", "git push", "git store"], correct_index: 1 },
                { question: "React.js qaysi kompaniya tomonidan yaratilgan?", answers: ["Google", "Microsoft", "Meta", "Apple"], correct_index: 2 },
                { question: "Python'da 'print' funksiyasi nima qiladi?", answers: ["Fayl yaratadi", "Ma'lumot chiqaradi", "O'zgaruvchi e'lon qiladi", "Dasturni to'xtatadi"], correct_index: 1 },
                { question: "HTTP qisqartmasi nimani anglatadi?", answers: ["Hyper Text Transfer Protocol", "High Tech Transfer Protocol", "Hyper Transfer Text Protocol", "Home Tool Transfer Protocol"], correct_index: 0 },
                { question: "Qaysi dasturlash tili eng ko'p veb-saytlarda ishlatiladi?", answers: ["Python", "Java", "JavaScript", "C++"], correct_index: 2 }
            ];
        }

        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
            return a;
        }

        function shuffleAns(q) {
            const ans = [...q.answers], correct = ans[q.correct_index], shuffled = shuffle(ans);
            return { answers: shuffled, correct_index: shuffled.indexOf(correct) };
        }

        function showPractice() {
            document.getElementById('modeList').classList.add('hidden');
            document.getElementById('practicePanel').classList.remove('hidden');
            const grid = document.getElementById('practiceGrid');
            grid.innerHTML = '';
            [5, 10].filter(n => n <= questions.length).forEach(n => {
                const btn = document.createElement('button');
                btn.className = 'practice-chip';
                btn.textContent = n;
                btn.onclick = () => startQuiz('test', n);
                grid.appendChild(btn);
            });
        }

        function hidePractice() {
            document.getElementById('modeList').classList.remove('hidden');
            document.getElementById('practicePanel').classList.add('hidden');
        }

        function startQuiz(m, count) {
            mode = m;
            questions = shuffle(getDemo());
            if (count) questions = questions.slice(0, count);
            maps = {};
            questions.forEach((q, i) => maps[i] = shuffleAns(q));
            current = 0; selected = null; answered = false; score = { correct: 0, wrong: 0 };
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('navBar').classList.remove('hidden');
            render();
        }

        function render() {
            const q = questions[current], map = maps[current], total = questions.length;
            const pct = ((current + 1) / total) * 100, circ = 138.2;
            document.getElementById('progressCircle').style.strokeDashoffset = circ - (pct / 100) * circ;
            document.getElementById('progressNum').textContent = `${current + 1}/${total}`;
            document.getElementById('scoreCorrect').textContent = score.correct;
            document.getElementById('scoreWrong').textContent = score.wrong;
            document.getElementById('qBadge').textContent = `Savol ${current + 1}`;
            document.getElementById('qText').textContent = q.question;

            const list = document.getElementById('answersList');
            list.innerHTML = '';
            map.answers.forEach((ans, i) => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                if (answered) div.classList.add('locked');
                if (i === selected && !answered) div.classList.add('selected');
                if (answered && i === map.correct_index) div.classList.add('correct');
                if (answered && i === selected && i !== map.correct_index) div.classList.add('wrong');
                const letter = String.fromCharCode(65 + i);
                let status = answered ? (i === map.correct_index ? '‚úì' : (i === selected ? '‚úó' : '')) : '';
                div.innerHTML = `<span class="answer-letter">${letter}</span><span class="answer-content">${ans}</span><span class="answer-status">${status}</span>`;
                div.onclick = () => selectAns(i);
                list.appendChild(div);
            });

            document.getElementById('btnPrev').disabled = current === 0;
            updateMainBtn();
            const card = document.getElementById('questionCard');
            card.style.animation = 'none'; card.offsetHeight; card.style.animation = 'cardAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
        }

        function updateMainBtn() {
            const btn = document.getElementById('btnMain');
            if (!answered) btn.textContent = mode === 'learn' ? (selected !== null ? '‚ö° Tekshirish' : 'üëÅ Ko\'rish') : 'ü§î Tanlang';
            else btn.textContent = current < questions.length - 1 ? 'Keyingi ‚Üí' : 'üèÅ Yakunlash';
        }

        function selectAns(i) {
            if (answered) return;
            selected = i;
            if (mode === 'test') checkAns(); else render();
        }

        function mainAction() {
            if (!answered) { if (mode === 'learn') { if (selected !== null) checkAns(); else showAns(); } }
            else { if (current < questions.length - 1) goNext(); else showResults(); }
        }

        function checkAns() {
            if (selected === null && mode !== 'learn') return;
            answered = true;
            const map = maps[current];
            if (selected === map.correct_index) { score.correct++; try { tg.HapticFeedback.notificationOccurred('success'); } catch(e) {} }
            else { score.wrong++; try { tg.HapticFeedback.notificationOccurred('error'); } catch(e) {} }
            render();
        }

        function showAns() {
            answered = true;
            const map = maps[current];
            if (selected !== null && selected !== map.correct_index) score.wrong++;
            render();
        }

        function goNext() { if (current < questions.length - 1) { current++; selected = null; answered = false; render(); } }
        function goPrev() { if (current > 0) { current--; selected = null; answered = false; render(); } }
        function goRandom() {
            if (questions.length <= 1) return;
            let n; do { n = Math.floor(Math.random() * questions.length); } while (n === current);
            current = n; selected = null; answered = false; render();
            try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
        }

        function showResults() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('navBar').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            const total = questions.length, pct = Math.round((score.correct / total) * 100);
            document.getElementById('statCorrect').textContent = score.correct;
            document.getElementById('statWrong').textContent = score.wrong;
            document.getElementById('resultPct').textContent = pct + '%';
            setTimeout(() => { document.getElementById('resultCircle').style.strokeDashoffset = 439.8 - (pct / 100) * 439.8; }, 200);
            let emoji, title, sub;
            if (pct >= 90) { emoji = 'üèÜ'; title = 'Ajoyib!'; sub = 'Siz zo\'rsiz!'; }
            else if (pct >= 70) { emoji = 'üéâ'; title = 'Yaxshi!'; sub = 'Zo\'r natija!'; }
            else if (pct >= 50) { emoji = 'üëç'; title = 'Qoniqarli'; sub = 'Yaxshi harakat!'; }
            else { emoji = 'üìö'; title = 'Takrorlang'; sub = 'Yana urinib ko\'ring!'; }
            document.getElementById('resultEmoji').textContent = emoji;
            document.getElementById('resultTitle').textContent = title;
            document.getElementById('resultSub').textContent = sub;
        }

        function restart() {
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            hidePractice();
        }

        function closeApp() { tg.close(); }

        init();
    </script>
</body>
</html>
